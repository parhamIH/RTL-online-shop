{% extends "shared/_Main.html" %}
{% load static %}
{% load humanize %}

<style>
    .product-price {
        margin: 10px 0;
    }
    
    .price-old {
        text-decoration: line-through;
        color: #999;
        margin-right: 10px;
        font-size: 0.9rem;
    }
    
    .price-current {
        font-weight: bold;
        color: #e74c3c;
        font-size: 1.1rem;
    }

    .color-circle {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
        border: 1px solid #ddd;
    }

    .availability-badge {
        font-size: 0.8rem;
        padding: 3px 8px;
        border-radius: 4px;
    }

    .product-card {
        transition: transform 0.3s ease;
    }

    .product-card:hover {
        transform: translateY(-5px);
    }

    .product-image {
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
    }
</style>
<!-- start content -->
{% block main %}
<div class="content">
    <div class="container-fluid">
        <!-- منوی موبایل -->
        <div class="custom-filter d-lg-none d-block">
            <button class="btn btn-filter-float border-0 main-color-two-bg shadow-box px-4 rounded-3 position-fixed" style="z-index: 999;bottom:80px;" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                <i class="bi bi-list font-20 fw-bold text-white"></i>
                <span class="d-block font-14 text-white">منو</span>
            </button>

            <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title">منو</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <div class="panel-nav-logo">
                        <a href="/" class="text-center d-block mb-3">
                            <img src="{% static 'assets/img/logo.png' %}" alt="" class="img-fluid" width="200">
                        </a>
                    </div>
                    <div class="penel-nav">
                        <div class="panel-nav-nav">
                            <nav class="navbar profile-box-nav">
                                <ul class="navbar-nav flex-column">
                                    <li class="nav-item {% if request.path == '/profile' %}active{% endif %}"><a href="/profile" class="nav-link">
                                        <i class="bi bi-house-door"></i>پروفایل</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/orders' %}active{% endif %}"><a href="/profile/orders" class="nav-link">
                                        <i class="bi bi-cart-check"></i>سفارش های من</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/address' %}active{% endif %}"><a href="/profile/address" class="nav-link">
                                        <i class="bi bi-pin-map"></i>آدرس های من</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/notification' %}active{% endif %}"><a href="/profile/notification" class="nav-link">
                                        <i class="bi bi-bell"></i>پیام ها و اطلاعیه ها</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/comments' %}active{% endif %}"><a href="/profile/comments" class="nav-link">
                                        <i class="bi bi-chat-dots"></i>نظرات من</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/support' %}active{% endif %}"><a href="/support" class="nav-link">
                                        <i class="bi bi-question-circle"></i>درخواست پشتیبانی</a>
                                    </li>
                                    {% if user.is_staff %}
                                    <li class="nav-item {% if request.path == '/support/admin/' %}active{% endif %}"><a href="/support/admin/" class="nav-link">
                                        <i class="bi bi-headset"></i>پنل مدیریت تیکت‌ها</a>
                                    </li>
                                    {% endif %}
                                    <li class="nav-item {% if request.path == '/profile/list' %}active{% endif %}"><a href="/profile/list" class="nav-link">
                                        <i class="bi bi-heart"></i>محصولات مورد علاقه</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/offers' %}active{% endif %}"><a href="/profile/offers" class="nav-link">
                                        <i class="bi bi-gift"></i>کد های تخفیف من</a>
                                    </li>
                                    <li class="nav-item"><a href="/logout/" class="nav-link">
                                        <i class="bi bi-arrow-right-square"></i>خروج از حساب کاربری</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel position-relative">
            <div class="row gy-4">
                <!-- منوی دسکتاپ -->
                <div class="col-lg-3 d-lg-block d-none">
                    <div class="panel-nav-logo">
                        <a href="/" class="text-center d-block mb-3">
                            <img src="{% static 'assets/img/logo.png' %}" alt="" class="img-fluid" width="200">
                        </a>
                    </div>
                    <div class="penel-nav">
                        <div class="panel-nav-nav">
                            <nav class="navbar profile-box-nav">
                                <ul class="navbar-nav flex-column">
                                    <li class="nav-item {% if request.path == '/profile' %}active{% endif %}"><a href="/profile" class="nav-link">
                                        <i class="bi bi-house-door"></i>پروفایل</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/orders' %}active{% endif %}"><a href="/profile/orders" class="nav-link">
                                        <i class="bi bi-cart-check"></i>سفارش های من</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/address' %}active{% endif %}"><a href="/profile/address" class="nav-link">
                                        <i class="bi bi-pin-map"></i>آدرس های من</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/notification' %}active{% endif %}"><a href="/profile/notification" class="nav-link">
                                        <i class="bi bi-bell"></i>پیام ها و اطلاعیه ها</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/comments' %}active{% endif %}"><a href="/profile/comments" class="nav-link">
                                        <i class="bi bi-chat-dots"></i>نظرات من</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/support' %}active{% endif %}"><a href="/support" class="nav-link">
                                        <i class="bi bi-question-circle"></i>درخواست پشتیبانی</a>
                                    </li>
                                    {% if user.is_staff %}
                                    <li class="nav-item {% if request.path == '/support/admin/' %}active{% endif %}"><a href="/support/admin/" class="nav-link">
                                        <i class="bi bi-headset"></i>پنل مدیریت تیکت‌ها</a>
                                    </li>
                                    {% endif %}
                                    <li class="nav-item {% if request.path == '/profile/list' %}active{% endif %}"><a href="/profile/list" class="nav-link">
                                        <i class="bi bi-heart"></i>محصولات مورد علاقه</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/offers' %}active{% endif %}"><a href="/profile/offers" class="nav-link">
                                        <i class="bi bi-gift"></i>کد های تخفیف من</a>
                                    </li>
                                    <li class="nav-item"><a href="/logout/" class="nav-link">
                                        <i class="bi bi-arrow-right-square"></i>خروج از حساب کاربری</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- محتوای اصلی -->
                <div class="col-lg-9">
                    <div class="position-sticky top-0">
                        <!-- هدر پنل -->
                        <div class="panel-header mb-3">
                            <div class="content-box">
                                <div class="container-fluid">
                                    <div class="row gy-5 align-items-center">
                                        <div class="col-md-6 col-8">
                                            <div class="d-flex align-items-center">
                                                <h6> {% if first_name %} {{first_name}} {% elif username %} {{username}} {% else %} کاربر {% endif %} عزیز به پنل کاربری خوش آمدید</h6>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-4">
                                            <div class="panel-alert d-flex justify-content-end">
                                                <a href="/profile/notification">
                                                    <i class="bi bi-bell pointer"></i>
                                                </a>
                                                <span class="count-item rounded-circle"> {{notifications_count}} </span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex align-items-center panel-profile">
                                                <img src="{% static 'assets/img/user.png' %}" class="img-fluid img-profile-panel rounded-circle me-3 shadow-md" alt="">
                                                <div class="d-grid gap-2">
                                                    <h6 class="font-14 main-color-one-color">حساب کاربری من</h6>
                                                    <div class="d-flex align-items-center">
                                                        <h6 class="font-14">
                                                            {{username}}</h6>
                                                        <a href="/profile/informations" class="ms-2"><i class="bi bi-pencil-square"></i></a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- عنوان صفحه -->
                        <div class="slider-title mt-4">
                            <div class="slider-title-desc">
                                <div class="slider-title-title pb-4">
                                    <h2 class="h1"><span class="title-font main-color-one-color">محصولات</span> مورد علاقه </h2>
                                </div>
                            </div>
                        </div>

                        <!-- لیست محصولات مورد علاقه -->
                        <div class="penel-form">
                            <div class="content-box">
                                <div class="container-fluid">
                                    <div class="row g-3" id="favorites-container">
                                        {% if favourite_products %}
                                            {% for product in favourite_products %}
                                                <div id="product-card-{{ product.id }}" class="col-md-6 product-card">
                                                    <div class="card h-100 border-0 rounded-4 shadow-sm">
                                                        <div class="card-body p-3">
                                                            <div class="row align-items-center">
                                                                <div class="col-4 ps-0">
                                                                    {% if product.image %}
                                                                        <img src="{{ product.image }}" alt="{{ product.name }}" 
                                                                             class="img-fluid rounded-3 product-image">
                                                                    {% else %}
                                                                        <img src="{% static 'assets/img/no-image.png' %}" 
                                                                             alt="تصویر موجود نیست" 
                                                                             class="img-fluid rounded-3 product-image">
                                                                    {% endif %}
                                                                </div>
                                                                <div class="col-8">
                                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                                        <a href="/product/{{ product.id }}/{{ product.name }}" 
                                                                           class="text-decoration-none">
                                                                            <h3 class="text-overflow-1 title-font font-14 mb-0">
                                                                                {{ product.name }}
                                                                            </h3>
                                                                        </a>
                                                                        {% if product.is_available %}
                                                                            <span class="badge bg-success availability-badge">موجود</span>
                                                                        {% else %}
                                                                            <span class="badge bg-danger availability-badge">ناموجود</span>
                                                                        {% endif %}
                                                                    </div>

                                                                    {% if product.color %}
                                                                    <div class="product-color mb-2">
                                                                        <span class="color-circle" 
                                                                              style="background-color: {{ product.color.code }};" 
                                                                              title="{{ product.color.name }}"></span>
                                                                        <small class="text-muted">{{ product.color.name }}</small>
                                                                    </div>
                                                                    {% endif %}

                                                                    <div class="product-price mb-3">
                                                                        {% if product.price > 0 %}
                                                                            <span class="price-current">
                                                                                {{ product.price|intcomma }} تومان
                                                                            </span>
                                                                        {% else %}
                                                                            <span class="text-muted">
                                                                                قیمت موجود نیست
                                                                            </span>
                                                                        {% endif %}
                                                                    </div>

                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                        <a href="/product/{{ product.id }}/{{ product.name }}" 
                                                                           class="btn btn-sm btn-primary">
                                                                            <i class="bi bi-eye me-1"></i> مشاهده
                                                                        </a>
                                                                        <button onclick="removeFromFavorites({{ product.id }})" 
                                                                                class="btn btn-sm btn-outline-danger">
                                                                            <i class="bi bi-trash me-1"></i> حذف
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="col-12">
                                                <div class="alert alert-info">لیست علاقه‌مندی‌های شما خالی است.</div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- صفحه‌بندی -->
                        {% if favourite_products.has_other_pages %}
                        <div class="my-paginate mt-5">
                            <nav aria-label="Page navigation example">
                                <ul class="pagination justify-content-center">
                                    {% if favourite_products.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link rounded-3" href="?page={{ favourite_products.previous_page_number }}"><i class="bi bi-chevron-right"></i></a>
                                    </li>
                                    {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link rounded-3" href="#"><i class="bi bi-chevron-right"></i></a>
                                    </li>
                                    {% endif %}
                                    
                                    {% for i in favourite_products.paginator.page_range %}
                                        {% if favourite_products.number == i %}
                                            <li class="page-item active"><a class="page-link rounded-3" href="#">{{ i }}</a></li>
                                        {% elif i > favourite_products.number|add:'-3' and i < favourite_products.number|add:'3' %}
                                            <li class="page-item"><a class="page-link rounded-3" href="?page={{ i }}">{{ i }}</a></li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if favourite_products.has_next %}
                                    <li class="page-item">
                                        <a class="page-link rounded-3" href="?page={{ favourite_products.next_page_number }}"><i class="bi bi-chevron-left"></i></a>
                                    </li>
                                    {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link rounded-3" href="#"><i class="bi bi-chevron-left"></i></a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- اسکریپت برای حذف محصول از علاقه‌مندی‌ها -->
<script>
// تعریف CSRF token برای استفاده در درخواست‌های AJAX
var csrftoken = "{{ csrf_token }}";

// حذف محصول از علاقه‌مندی‌ها با Ajax
function removeFromFavorites(productId) {
    $.ajax({
        url: "{% url 'remove_from_favorites' %}",
        type: "POST",
        data: {
            'product_id': productId,
            'csrfmiddlewaretoken': csrftoken
        },
        headers: {
            "X-Requested-With": "XMLHttpRequest",
        },
        success: function(response) {
            // نمایش پیام موفقیت
            showNotification(response.message, response.status);
            
            // در صورت موفقیت‌آمیز بودن، حذف کارت محصول از صفحه
            if (response.status === 'success') {
                $("#product-card-"+productId).fadeOut(300, function() {
                    $(this).remove();
                    
                    // اگر لیست خالی شد، پیام مناسب نمایش داده شود
                    if ($('.product-card').length === 0) {
                        $("#favorites-container").html('<div class="col-12"><div class="alert alert-info">لیست علاقه‌مندی‌های شما خالی است.</div></div>');
                    }
                });
            }
        },
        error: function(xhr, status, error) {
            // نمایش پیام خطا
            var errorMessage = "خطایی رخ داد. لطفاً مجدداً تلاش کنید.";
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            }
            showNotification(errorMessage, 'error');
        }
    });
}

// نمایش اعلان‌ها به کاربر
function showNotification(message, type) {
    var notificationClass = 'alert-info';
    if (type === 'success') notificationClass = 'alert-success';
    if (type === 'error') notificationClass = 'alert-danger';
    
    var notification = $('<div class="alert ' + notificationClass + ' notification">' + message + '</div>');
    $("body").append(notification);
    
    // مخفی کردن اعلان پس از چند ثانیه
    setTimeout(function() {
        notification.fadeOut(300, function() { $(this).remove(); });
    }, 3000);
}
</script>

<!-- استایل برای اعلان‌ها -->
<style>
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    padding: 15px;
    border-radius: 4px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    max-width: 350px;
}

.product-price .price-old {
    font-size: 0.9rem;
}

.product-price .price-current {
    font-size: 1.1rem;
}
</style>

<!-- end content -->


{% endblock main %}
