{% extends "shared/_Main.html" %}
{% load static %}
{% load humanize %}

{% block main %}


<!-- end breadcroumb -->


<!-- start content -->

<div class="content">
    <div class="container-fluid">

        <div class="custom-filter d-lg-none d-block">
            <button class="btn btn-filter-float border-0 main-color-two-bg shadow-box px-4 rounded-3 position-fixed" style="z-index: 999;bottom:80px;" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                <i class="bi bi-list font-20 fw-bold text-white"></i>
                <span class="d-block font-14 text-white">منو</span>
            </button>

            <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title">منو</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <div class="panel-nav-logo">
                        <a href="" class="text-center d-block mb-3">
                            <img src="{% static 'assets/img/logo.png' %}" alt="" class="img-fluid" width="200">
                        </a>
                    </div>
                    <div class="penel-nav">
                        <div class="panel-nav-nav">
                            <nav class="navbar profile-box-nav">
                                <ul class="navbar-nav flex-column">
                                    <li class="nav-item {% if request.path == '/profile' %}active{% endif %}"><a href="/profile" class="nav-link">
                                        <i class="bi bi-house-door"></i>پروفایل</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/orders' %}active{% endif %}"><a href="/profile/orders" class="nav-link">
                                        <i class="bi bi-cart-check"></i>سفارش های من</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/address' %}active{% endif %}"><a href="/profile/address" class="nav-link">
                                        <i class="bi bi-pin-map"></i>آدرس های من</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/notification' %}active{% endif %}"><a href="/profile/notification" class="nav-link">
                                        <i class="bi bi-bell"></i>پیام ها و اطلاعیه ها</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/comments' %}active{% endif %}"><a href="/profile/comments" class="nav-link">
                                        <i class="bi bi-chat-dots"></i>نظرات من</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/support' %}active{% endif %}"><a href="/support" class="nav-link">
                                        <i class="bi bi-question-circle"></i>درخواست پشتیبانی</a>
                                    </li>
                                    {% if user.is_staff %}
                                    <li class="nav-item {% if request.path == '/support/admin/' %}active{% endif %}"><a href="/support/admin/" class="nav-link">
                                        <i class="bi bi-headset"></i>پنل مدیریت تیکت‌ها</a>
                                    </li>
                                    {% endif %}
                                    <li class="nav-item {% if request.path == '/profile/list' %}active{% endif %}"><a href="/profile/list" class="nav-link">
                                        <i class="bi bi-heart"></i>محصولات مورد علاقه</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/offers' %}active{% endif %}"><a href="/profile/offers" class="nav-link">
                                        <i class="bi bi-gift"></i>کد های تخفیف من</a>
                                    </li>
                                    <li class="nav-item"><a href="/logout/" class="nav-link">
                                        <i class="bi bi-arrow-right-square"></i>خروج از حساب کاربری</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel position-relative">
            <div class="row gy-4">
                <div class="col-lg-3 d-lg-block d-none">
                    <div class="panel-nav-logo">
                        <a href="" class="text-center d-block mb-3">
                            <img src="{% static 'assets/img/logo.png' %}" alt="" class="img-fluid" width="200">
                        </a>
                    </div>
                    <div class="penel-nav">
                        <div class="panel-nav-nav">
                            <nav class="navbar profile-box-nav">
                                <ul class="navbar-nav flex-column">
                                    <li class="nav-item {% if request.path == '/profile' %}active{% endif %}"><a href="/profile" class="nav-link">
                                        <i class="bi bi-house-door"></i>پروفایل</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/orders' %}active{% endif %}"><a href="/profile/orders" class="nav-link">
                                        <i class="bi bi-cart-check"></i>سفارش های من</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/address' %}active{% endif %}"><a href="/profile/address" class="nav-link">
                                        <i class="bi bi-pin-map"></i>آدرس های من</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/notification' %}active{% endif %}"><a href="/profile/notification" class="nav-link">
                                        <i class="bi bi-bell"></i>پیام ها و اطلاعیه ها</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/comments' %}active{% endif %}"><a href="/profile/comments" class="nav-link">
                                        <i class="bi bi-chat-dots"></i>نظرات من</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/support' %}active{% endif %}"><a href="/support" class="nav-link">
                                        <i class="bi bi-question-circle"></i>درخواست پشتیبانی</a>
                                    </li>
                                    {% if user.is_staff %}
                                    <li class="nav-item {% if request.path == '/support/admin/' %}active{% endif %}"><a href="/support/admin/" class="nav-link">
                                        <i class="bi bi-headset"></i>پنل مدیریت تیکت‌ها</a>
                                    </li>
                                    {% endif %}
                                    <li class="nav-item {% if request.path == '/profile/list' %}active{% endif %}"><a href="/profile/list" class="nav-link">
                                        <i class="bi bi-heart"></i>محصولات مورد علاقه</a>
                                    </li>
                                    <li class="nav-item {% if request.path == '/profile/offers' %}active{% endif %}"><a href="/profile/offers" class="nav-link">
                                        <i class="bi bi-gift"></i>کد های تخفیف من</a>
                                    </li>
                                    <li class="nav-item"><a href="/logout/" class="nav-link">
                                        <i class="bi bi-arrow-right-square"></i>خروج از حساب کاربری</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                <div class="col-lg-9">
                    <div class="position-sticky top-0">
                        <div class="panel-header mb-3">
                            <div class="content-box">
                                <div class="container-fluid">
                                    <div class="row gy-5 align-items-center">
                                        <div class="col-md-6 col-8">
                                            <div class="d-flex align-items-center">
                                                <h6> {% if first_name %} {{first_name}} {% elif username %} {{username}} {% else %} کاربر {% endif %} عزیز به پنل کاربری خوش آمدید</h6>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-4">
                                            <div class="panel-alert d-flex justify-content-end">
                                                <i class="bi bi-bell pointer"></i>
                                                <span class="count-item rounded-circle">{{notifications_count}}</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex align-items-center panel-profile">
                                                <img src="{% static 'assets/img/user.png' %}" class="img-fluid img-profile-panel rounded-circle me-3 shadow-md" alt="">
                                                <div class="d-grid gap-2">
                                                    <h6 class="font-14 main-color-one-color">حساب کاربری من</h6>
                                                    <div class="d-flex align-items-center">
                                                        <h6 class="font-14">
                                                            {% if first_name %} {{first_name}} {% elif username %} {{username}} {% else %} کاربر {% endif %}
                                                        </h6>
                                                        <a href="" class="ms-2"><i class="bi bi-pencil-square"></i></a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="slider-title mt-4">
                            <div class="slider-title-desc">
                                <div class="slider-title-title pb-4">
                                    <h2 class="h1"><span class="title-font main-color-one-color">ویرایش</span> پروفایل </h2>
                                </div>
                            </div>
                        </div>

                        <div class="penel-form">
                            <div class="content-box">
                                <div class="container-fluid">
                                    <!-- Personal Information Cards -->
                                    <div class="row g-4">
                                        <!-- Name and Last Name Card -->
                                        <div class="col-md-6">
                                            <div class="profile-info-card shadow-sm rounded-3 p-3 bg-white position-relative">
                                                <h6 class="fs-5 mb-3 border-bottom pb-2">اطلاعات شخصی</h6>
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <p class="text-muted mb-1">نام و نام خانوادگی</p>
                                                        <p class="fw-bold">{{ user.first_name }} {{ user.last_name }}</p>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-link text-decoration-none" data-bs-toggle="modal" data-bs-target="#nameModal">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- National ID Card -->
                                        <div class="col-md-6">
                                            <div class="profile-info-card shadow-sm rounded-3 p-3 bg-white position-relative">
                                                <h6 class="fs-5 mb-3 border-bottom pb-2">کد ملی</h6>
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <p class="fw-bold">{{ user.profile.national_id|default:"تنظیم نشده" }}</p>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-link text-decoration-none" data-bs-toggle="modal" data-bs-target="#nationalIdModal">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Phone Number Card -->
                                        <div class="col-md-6">
                                            <div class="profile-info-card shadow-sm rounded-3 p-3 bg-white position-relative">
                                                <h6 class="fs-5 mb-3 border-bottom pb-2">شماره موبایل</h6>
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <p class="fw-bold">{{ user.profile.phone_number|default:"تنظیم نشده" }}</p>
                                                        {% if not user.profile.is_phone_verified %}
                                                        <span class="badge bg-warning">تایید نشده</span>
                                                        {% endif %}
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-link text-decoration-none" data-bs-toggle="modal" data-bs-target="#phoneModal">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Email Card -->
                                        <div class="col-md-6">
                                            <div class="profile-info-card shadow-sm rounded-3 p-3 bg-white position-relative">
                                                <h6 class="fs-5 mb-3 border-bottom pb-2">ایمیل</h6>
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <p class="fw-bold">{{ user.email|default:"تنظیم نشده" }}</p>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-link text-decoration-none" data-bs-toggle="modal" data-bs-target="#emailModal">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Password Card -->
                                        <div class="col-md-6">
                                            <div class="profile-info-card shadow-sm rounded-3 p-3 bg-white position-relative">
                                                <h6 class="fs-5 mb-3 border-bottom pb-2">رمز عبور</h6>
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <p class="fw-bold">•••••••</p>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-link text-decoration-none" data-bs-toggle="modal" data-bs-target="#passwordModal">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Refund Method Card -->
                                        <div class="col-md-6">
                                            <div class="profile-info-card shadow-sm rounded-3 p-3 bg-white position-relative">
                                                <h6 class="fs-5 mb-3 border-bottom pb-2">روش بازگرداندن پول من</h6>
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <p class="fw-bold">{{ user.profile.refund_method|default:"تنظیم نشده" }}</p>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-link text-decoration-none" data-bs-toggle="modal" data-bs-target="#refundModal">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Birth Date Card -->
                                        <div class="col-md-6">
                                            <div class="profile-info-card shadow-sm rounded-3 p-3 bg-white position-relative">
                                                <h6 class="fs-5 mb-3 border-bottom pb-2">تاریخ تولد</h6>
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <p class="fw-bold">{{ user.profile.birth_date|date:"Y/m/d"|default:"تنظیم نشده" }}</p>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-link text-decoration-none" data-bs-toggle="modal" data-bs-target="#birthDateModal">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Job Card -->
                                        <div class="col-md-6">
                                            <div class="profile-info-card shadow-sm rounded-3 p-3 bg-white position-relative">
                                                <h6 class="fs-5 mb-3 border-bottom pb-2">شغل</h6>
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <p class="fw-bold">{{ user.profile.job|default:"تنظیم نشده" }}</p>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-link text-decoration-none" data-bs-toggle="modal" data-bs-target="#jobModal">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Economic Code Card -->
                                        <div class="col-md-6">
                                            <div class="profile-info-card shadow-sm rounded-3 p-3 bg-white position-relative">
                                                <h6 class="fs-5 mb-3 border-bottom pb-2">کد اقتصادی</h6>
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <p class="fw-bold">{{ user.profile.economic_code|default:"تنظیم نشده" }}</p>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-link text-decoration-none" data-bs-toggle="modal" data-bs-target="#economicCodeModal">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Legal Info Card -->
                                        <div class="col-md-6">
                                            <div class="profile-info-card shadow-sm rounded-3 p-3 bg-white position-relative">
                                                <h6 class="fs-5 mb-3 border-bottom pb-2">اطلاعات حقوقی</h6>
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <p class="fw-bold">{{ user.profile.legal_info|default:"تنظیم نشده" }}</p>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-link text-decoration-none" data-bs-toggle="modal" data-bs-target="#legalInfoModal">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals for Editing Information -->

<!-- Name Modal -->
<div class="modal fade" id="nameModal" tabindex="-1" aria-labelledby="nameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nameModalLabel">ویرایش نام و نام خانوادگی</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'edit_profile' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="first_name" class="form-label">نام</label>
                        <input type="text" class="form-control" id="first_name" name="first_name" value="{{ user.first_name }}">
                    </div>
                    <div class="mb-3">
                        <label for="last_name" class="form-label">نام خانوادگی</label>
                        <input type="text" class="form-control" id="last_name" name="last_name" value="{{ user.last_name }}">
                    </div>
                    <input type="hidden" name="form_type" value="name_form">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn main-color-one-bg text-white">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- National ID Modal -->
<div class="modal fade" id="nationalIdModal" tabindex="-1" aria-labelledby="nationalIdModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nationalIdModalLabel">ویرایش کد ملی</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'edit_profile' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="national_id" class="form-label">کد ملی</label>
                        <input type="text" class="form-control" id="national_id" name="national_id" 
                               value="{{ user.profile.national_id|default:'' }}" 
                               pattern="[0-9]{10}" 
                               maxlength="10" 
                               oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        <small class="form-text text-muted">کد ملی باید دقیقاً 10 رقم باشد و با الگوریتم صحیح کد ملی ایران مطابقت داشته باشد.</small>
                        <div id="national_id_validation" class="invalid-feedback">
                            کد ملی وارد شده معتبر نیست.
                        </div>
                    </div>
                    <input type="hidden" name="form_type" value="national_id_form">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn main-color-one-bg text-white">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Phone Modal -->
<div class="modal fade" id="phoneModal" tabindex="-1" aria-labelledby="phoneModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="phoneModalLabel">ویرایش شماره موبایل</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'edit_profile' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="phone_number" class="form-label">شماره موبایل</label>
                        <input type="text" class="form-control" id="phone_number" name="phone_number" value="{{ user.profile.phone_number|default:'' }}">
                        <small class="form-text text-muted">شماره موبایل باید با 09 شروع شود و 11 رقم باشد.</small>
                    </div>
                    <input type="hidden" name="form_type" value="phone_form">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn main-color-one-bg text-white">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Email Modal -->
<div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailModalLabel">ویرایش ایمیل</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'edit_profile' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="email" class="form-label">ایمیل</label>
                        <input type="email" class="form-control" id="email" name="email" value="{{ user.email|default:'' }}">
                    </div>
                    <input type="hidden" name="form_type" value="email_form">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn main-color-one-bg text-white">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="passwordModalLabel">تغییر رمز عبور</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'edit_profile' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="old_password" class="form-label">رمز عبور فعلی</label>
                        <input type="password" class="form-control" id="old_password" name="old_password">
                    </div>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">رمز عبور جدید</label>
                        <input type="password" class="form-control" id="new_password" name="new_password">
                    </div>
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">تکرار رمز عبور جدید</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password">
                    </div>
                    <input type="hidden" name="form_type" value="password_form">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn main-color-one-bg text-white">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Refund Method Modal -->
<div class="modal fade" id="refundModal" tabindex="-1" aria-labelledby="refundModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="refundModalLabel">روش بازگرداندن پول</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'edit_profile' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="refund_method" class="form-label">روش بازگرداندن پول</label>
                        <select class="form-select" id="refund_method" name="refund_method">
                            <option value="" {% if not user.profile.refund_method %}selected{% endif %}>انتخاب کنید</option>
                            <option value="کیف پول" {% if user.profile.refund_method == "کیف پول" %}selected{% endif %}>کیف پول</option>
                            <option value="حساب بانکی" {% if user.profile.refund_method == "حساب بانکی" %}selected{% endif %}>حساب بانکی</option>
                            <option value="کارت بانکی" {% if user.profile.refund_method == "کارت بانکی" %}selected{% endif %}>کارت بانکی</option>
                        </select>
                    </div>
                    <input type="hidden" name="form_type" value="refund_method_form">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn main-color-one-bg text-white">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Birth Date Modal -->
<div class="modal fade" id="birthDateModal" tabindex="-1" aria-labelledby="birthDateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="birthDateModalLabel">تاریخ تولد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'edit_profile' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="birth_date" class="form-label">تاریخ تولد</label>
                        <input type="date" class="form-control" id="birth_date" name="birth_date" value="{{ user.profile.birth_date|date:'Y-m-d'|default:'' }}">
                    </div>
                    <input type="hidden" name="form_type" value="birth_date_form">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn main-color-one-bg text-white">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Job Modal -->
<div class="modal fade" id="jobModal" tabindex="-1" aria-labelledby="jobModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobModalLabel">شغل</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'edit_profile' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="job" class="form-label">شغل</label>
                        <input type="text" class="form-control" id="job" name="job" value="{{ user.profile.job|default:'' }}">
                    </div>
                    <input type="hidden" name="form_type" value="job_form">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn main-color-one-bg text-white">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Economic Code Modal -->
<div class="modal fade" id="economicCodeModal" tabindex="-1" aria-labelledby="economicCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="economicCodeModalLabel">کد اقتصادی</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'edit_profile' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="economic_code" class="form-label">کد اقتصادی</label>
                        <input type="text" class="form-control" id="economic_code" name="economic_code" value="{{ user.profile.economic_code|default:'' }}">
                    </div>
                    <input type="hidden" name="form_type" value="economic_code_form">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn main-color-one-bg text-white">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Legal Info Modal -->
<div class="modal fade" id="legalInfoModal" tabindex="-1" aria-labelledby="legalInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="legalInfoModalLabel">اطلاعات حقوقی</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'edit_profile' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="legal_info" class="form-label">اطلاعات حقوقی</label>
                        <textarea class="form-control" id="legal_info" name="legal_info" rows="4">{{ user.profile.legal_info|default:'' }}</textarea>
                    </div>
                    <input type="hidden" name="form_type" value="legal_info_form">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn main-color-one-bg text-white">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- end content -->
 <script src="{% static 'assets/js/change_ostan.js' %}"></script>
 
 <!-- JavaScript برای اعتبارسنجی کد ملی در سمت کلاینت -->
 <script>
    document.addEventListener('DOMContentLoaded', function() {
        // گرفتن المان‌های مورد نیاز
        const nationalIdInput = document.getElementById('national_id');
        const nationalIdValidation = document.getElementById('national_id_validation');
        
        // اعتبارسنجی کد ملی
        function validateIranianNationalId(nationalId) {
            // بررسی طول کد ملی
            if (!nationalId || nationalId.length !== 10) {
                return false;
            }
            
            // بررسی عددی بودن تمام کاراکترها
            if (!/^\d{10}$/.test(nationalId)) {
                return false;
            }
            
            // بررسی کدهای ملی غیرمعتبر
            const invalidCodes = [
                '0000000000', '1111111111', '2222222222', '3333333333',
                '4444444444', '5555555555', '6666666666', '7777777777',
                '8888888888', '9999999999'
            ];
            
            if (invalidCodes.includes(nationalId)) {
                return false;
            }
            
            // محاسبه رقم کنترلی
            const check = parseInt(nationalId[9]);
            let sum = 0;
            
            for (let i = 0; i < 9; i++) {
                sum += parseInt(nationalId[i]) * (10 - i);
            }
            
            const remainder = sum % 11;
            
            if (remainder < 2) {
                return check === remainder;
            } else {
                return check === (11 - remainder);
            }
        }
        
        // اضافه کردن event listener برای ورودی کد ملی
        if (nationalIdInput) {
            nationalIdInput.addEventListener('input', function() {
                const nationalId = this.value.trim();
                
                if (nationalId.length > 0) {
                    if (validateIranianNationalId(nationalId)) {
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    } else {
                        this.classList.remove('is-valid');
                        this.classList.add('is-invalid');
                    }
                } else {
                    // اگر فیلد خالی باشد، حالت اعتبارسنجی را حذف می‌کنیم
                    this.classList.remove('is-valid');
                    this.classList.remove('is-invalid');
                }
            });
            
            // اعتبارسنجی فرم قبل از ارسال
            nationalIdInput.closest('form').addEventListener('submit', function(event) {
                const nationalId = nationalIdInput.value.trim();
                
                if (nationalId.length > 0 && !validateIranianNationalId(nationalId)) {
                    event.preventDefault();
                    nationalIdInput.classList.add('is-invalid');
                    // اسکرول به سمت پیام خطا
                    nationalIdValidation.scrollIntoView({ behavior: 'smooth' });
                }
            });
        }
    });
 </script>
{% endblock main %}
